<div id="store_container">
    <script id="store_template" type="x-tmpl-mustache/text">
        <div class="main_banner text-center">
            <h3>{{name}}</h3>
        </div>
        <div class="main_container content_container">
            <div class="store_list_head">
                <div class="row">
                    <div class="col-md-12 store_top">
                        <h5 class="back_btn show_phone"><a href="/stores" class="store_anchors active_heading"><i class="fa fa-angle-left" aria-hidden="true"></i> BACK TO DIRECTORY</a></h5>
                        <a href="/stores" class="soft_hidden_phone store_anchors active_heading"><i class="fa fa-angle-left" aria-hidden="true"></i> BACK TO DIRECTORY</a>
                        <div class="store_details_anchors pull-right">
                            <a id="promo_anchor" href="#promos_main" class="store_anchors active_heading">
                                <img src="//codecloud.cdn.speedyrails.net/sites/57f7f01f6e6f647835890000/image/png/1466179730000/promo_icon.png" class="" alt="promo icon">
                                Promos (<span></span>)
                            </a>
                            <a id="job_anchor" href="#jobs_main" class="store_anchors active_heading">
                                <img src="//codecloud.cdn.speedyrails.net/sites/57f7f01f6e6f647835890000/image/png/1466179720000/jobs_icon.png" class="" alt="jobs icon">
                                Jobs (<span></span>)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="margin_25_across">
                <div class="row">
                    <div class="col-md-8">
                        <div class="details_desc">
                            
                             <img src="{{alt_store_front_url}}" class="store_logo hidden_phone" alt="{{name}}" />
                            <div class="margin_20">{{{rich_description}}}</div>
                            <!--<div id="mapsvg_store_detail" class="mobile_padding"></div>-->
                            <iframe src="https://mf-map.netlify.com/map?iframe=true&staging=true&subdomain=billings&hideStoreList=true" frameborder="0" width="100%" height="100%" id="iFrame1" sandbox="allow-top-navigation allow-scripts allow-same-origin"></iframe>
                            <img id="IE_map" src="">
                        </div>
                    </div>
                    <div class="col-md-4">
                       <img class="margin_20"  src="//codecloud.cdn.speedyrails.net/sites/59c3f9f46e6f646526050000/image/jpeg/1507226103000/billingsbridge_default.jpg"/>
                        <div class="side_stores">
                            <a class="animated_btn" href="tel:{{phone}}" style="{{phone_show}}">Phone: {{phone}}</a>
                            <a class="animated_btn" href="//{{website}}" target="_blank" style="{{show}}">Visit Website</a>
                        </div>
                    </div> 
                </div>
            </div>
        </div>
    </script>
</div>
<div class="main_container content_container">
    <div class="margin_25_across">
        <div class="row">
            <div class="col-md-8 promo_item" id="promos_main">
                <h2 class="store_details_promo_heading">
                    <img src="//codecloud.cdn.speedyrails.net/sites/56c740936e6f642d56000000/image/png/1456507166000/promo_icon.png" class="" alt="promo icon">
                    Promotions
                </h2>
                <div id="promos_container">
                    <script id="promos_template" type="x-tmpl-mustache/text">
                        <div class="row promo_item cats_row" data-cat="{{cat_list}}">
                            <div class="col-md-5">
                                <img class="promo_store_image" src="{{image_url}}" alt="{{name}}" />
                            </div>
                            <div class="col-md-7">
                                <h2 class="promo_list_name">{{name}}</h2>
                                <p>
                                    <span class="promo_dates">{{dates}}</span>
                                </p>
                                <div class="promo_list_desc">{{description_short}}</div>
                                <a class="read_more" href="/promotions/{{slug}}">Read More</a>
                            </div>
                        </div>
                    </script>
                </div>
            </div>
            <div class="col-md-8 promo_item" id="jobs_main">
                <h2 class="store_details_promo_heading">
                    <img src="//codecloud.cdn.speedyrails.net/sites/56c740936e6f642d56000000/image/png/1456507192000/jobs_icon.png" class="jobs_icon" alt="jobs icon">
                    Jobs
                </h2>
                <div id="jobs_container">
                    <script id="jobs_template" type="x-tmpl-mustache/text">
                        <div class="row promo_item" data-cat="{{cat_list}}">
                            <div class="col-md-12">
                                <h2 class="promo_list_name">{{name}}</h2>
                                <p>
                                    <span class="promo_dates">{{job_type}}</span>
                                </p>
                                <div class="promo_list_desc">{{description_short}}</div>
                                <a class="read_more" href="/jobs/{{slug}}">Read More</a>
                            </div>
                        </div>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
<!--<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.js"></script>-->
<!--<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/raphael.js"></script>-->
<!--<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.mousewheel.js"></script>-->
<!--<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/system/site_images/photos/000/005/107/original/mallmaverick_svgmap.js?1412885524"></script>-->
<script>
    let store_details = null
    $(document).ready(function(e){
        init(e);
        function renderAll (){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            store_details = getStoreDetailsBySlug(slug);
            renderStoreDetails("#store_container","#store_template", store_details, slug);
            
            //PROMOS
            var store_promo_ids = store_details.promotions
            var store_promos = getPromotionsForIds(store_promo_ids).sortBy(function(o){ return o.start_date });
            var published_promos = [];
            $.each( store_promos , function( key, val ){
                today = moment();
                webDate = moment(val.show_on_web_date);
                if (today >= webDate) {
                    published_promos.push(val)
                } 
            });
            if( published_promos.length > 0){
                renderPromotions("#promos_container","#promos_template", published_promos);
                $('#promo_anchor span').text(published_promos.length)
            } else {
                $('#promos_main').hide()
                $('#promo_anchor').hide()
            }
            
            // JOBS
            var store_job_ids = store_details.jobs
            var store_jobs = getJobsForIds(store_job_ids).sortBy(function(o){ return o.start_date });
            var published_jobs = [];
            $.each( store_jobs , function( key, val ){
                today = moment();
                webDate = moment(val.show_on_web_date);
                if (today >= webDate) {
                    published_jobs.push(val)
                } 
            });
            if( published_jobs.length > 0){
                renderJobs('#jobs_container', '#jobs_template', published_jobs);
                $('#job_anchor span').text(published_jobs.length)
            } else {
                $('#jobs_main').hide();
                $('#job_anchor').hide()
            }
        
            show_content();
            $('#iFrame1').css('display','block')
            console.log('IE ' + detectIE());
            if(detectIE()){
                var svg_url = getPropertyDetails().svgmap_url;
                console.log(svg_url)
                $('#iFrame1').remove();
                $("#IE_map").attr("src", svg_url)
                console.log('IE',$('#iFrame1').remove())
            }
        }
		loadMallDataCached(renderAll); 
    })
    window.addEventListener('message', function(event) {
        // IMPORTANT: check the origin of the data! 
        if (event.origin.startsWith('https://mf-map.netlify.com') && event.data.event === "store-details-clicked") { 
            // The data was sent from your site.
            // Data sent with postMessage is stored in event.data:
            if(event.data && event.data.selectedStore) {
                var store = event.data.selectedStore
                window.location.href= "/stores/"+store.slug
            }
        } else if (event.origin.startsWith('https://mf-map.netlify.com') && event.data.event === "map-loaded") {
            if(event.data) {
                var loading = event.data.loading;
                if (!loading){
                    let frame = document.getElementById('iFrame1');
                    frame.contentWindow.postMessage({ event: "select-store", selectedStore: store_details }, '*');
                }
            }
        }
    });
    function detectIE() {
        var ua = window.navigator.userAgent;
    
        var msie = ua.indexOf('MSIE ');
        if (msie > 0) {
            // IE 10 or older => return version number
            return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
        }
    
        var trident = ua.indexOf('Trident/');
        if (trident > 0) {
            // IE 11 => return version number
            var rv = ua.indexOf('rv:');
            return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
        }
    
        var edge = ua.indexOf('Edge/');
        if (edge > 0) {
           // Edge (IE 12+) => return version number
           return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
        }
    
        // other browser
        return false;
    }
</script>
<style>
    html, iframe{
        scroll-behavior: smooth;
        height: calc(100% - 101px) !important;
        top: 101px !important;
    }
    #iFrame1 {
        display: none;
        min-height: 500px;
    }
    @media (max-width: 768px) {
    #iFrame1 {
        display: none;
        min-height: 400px;
    }
    }
</style>